name: Azure Managed Pool - Basic setup test
run-name: Azure Managed Pool - Basic setup test

on:
    schedule:
        - cron: "15 06 * * 2"   # <=== Change this value    
    workflow_dispatch:
    
env:
  BadgeName: 'AzureManagedPool'
  BadgeLabel: 'AzureManagedPool'

      
jobs:
#   RunTerraform:
#     uses: ./.github/workflows/terraform-execute.yml
#     with:
#       backend_key: 'managed-pool'
#     secrets: inherit

  ValidateAPI:
    runs-on: ubuntu-latest
    # needs: RunTerraform

    steps:
      - name: Trigger Azure DevOps Pipeline
        shell: bash  
        env:
            ADO_PAT: ${{ secrets.ADO_PAT }}         # Must be defined in your repo’s “Settings → Secrets”
            ORGANIZATION: "azure-way"
            PROJECT: "basic-pipelines"
            PIPELINE_ID: "1"
        run: |
            # Use -u :$ADO_PAT to send Basic Auth
            curl -v \
                -u :$ADO_PAT \
                -X POST \
                -H "Content-Type: application/json" \
                -H "Accept: application/json" \
                -d '{"resources": {"repositories": {"self": {"refName": "refs/heads/main"}}}}' \
                "https://dev.azure.com/${ORGANIZATION}/${PROJECT}/_apis/pipelines/${PIPELINE_ID}/runs?api-version=7.1"    
          
    #   - name: Get current date

    #     id: date
    
    #     run: echo "::set-output name=date::$(date +'%Y-%m-%d')"          

    #   - name: Build-A-Badge-Success
    #     if: success()
    #     uses: peterrhodesdev/build-a-badge@v1.3.0
    #     with:
    #         token: ${{ secrets.GITHUB_TOKEN }}
    #         filename: ${{ env.BadgeName}}
    #         label: ${{ env.BadgeLabel }}
    #         message: "build date: ${{ steps.date.outputs.date }}"
    #         namedLogo: github
    #         labelColor: "#008000"
    #         color: "#3272d3"
  
    #   - name: Build-A-Badge-Failure
    #     if: failure()
    #     uses: peterrhodesdev/build-a-badge@v1.3.0
    #     with:
    #         token: ${{ secrets.GITHUB_TOKEN }}
    #         filename: ${{ env.BadgeName}}
    #         label: ${{ env.BadgeLabel }}
    #         message: "build date: ${{ steps.date.outputs.date }}"
    #         namedLogo: github
    #         labelColor: "#FF0000"
    #         color: "#3272d3"   

#   RunDestroyTerraform:
#     needs: ValidateAPI
#     uses: ./.github/workflows/terraform-destroy.yml
#     with:
#       backend_key: 'managed-pool'
#     secrets: inherit     